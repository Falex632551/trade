<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Analysis Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        select, button {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .chart-container {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .indicator-card {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
        }

        .prediction-up {
            color: #27ae60;
        }

        .prediction-down {
            color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Forex Analysis Platform</h1>
            <p>Real-time analysis and predictions for major and minor currency pairs</p>
        </div>

        <div class="controls">
            <select id="currencyPair">
                <optgroup label="Major Pairs">
                    <option value="EUR/USD">EUR/USD - ยูโร/ดอลลาร์สหรัฐ</option>
                    <option value="USD/JPY">USD/JPY - ดอลลาร์สหรัฐ/เยนญี่ปุ่น</option>
                    <option value="GBP/USD">GBP/USD - ปอนด์อังกฤษ/ดอลลาร์สหรัฐ</option>
                    <option value="USD/CHF">USD/CHF - ดอลลาร์สหรัฐ/ฟรังก์สวิส</option>
                    <option value="AUD/USD">AUD/USD - ดอลลาร์ออสเตรเลีย/ดอลลาร์สหรัฐ</option>
                    <option value="USD/CAD">USD/CAD - ดอลลาร์สหรัฐ/ดอลลาร์แคนาดา</option>
                    <option value="NZD/USD">NZD/USD - ดอลลาร์นิวซีแลนด์/ดอลลาร์สหรัฐ</option>
                </optgroup>
                <optgroup label="Minor Pairs">
                    <option value="EUR/GBP">EUR/GBP - ยูโร/ปอนด์อังกฤษ</option>
                    <option value="EUR/JPY">EUR/JPY - ยูโร/เยนญี่ปุ่น</option>
                    <option value="GBP/JPY">GBP/JPY - ปอนด์อังกฤษ/เยนญี่ปุ่น</option>
                    <option value="AUD/JPY">AUD/JPY - ดอลลาร์ออสเตรเลีย/เยนญี่ปุ่น</option>
                    <option value="EUR/AUD">EUR/AUD - ยูโร/ดอลลาร์ออสเตรเลีย</option>
                    <option value="GBP/AUD">GBP/AUD - ปอนด์อังกฤษ/ดอลลาร์ออสเตรเลีย</option>
                    <option value="NZD/JPY">NZD/JPY - ดอลลาร์นิวซีแลนด์/เยนญี่ปุ่น</option>
                    <option value="AUD/CAD">AUD/CAD - ดอลลาร์ออสเตรเลีย/ดอลลาร์แคนาดา</option>
                    <option value="GBP/CHF">GBP/CHF - ปอนด์อังกฤษ/ฟรังก์สวิส</option>
                    <option value="EUR/CHF">EUR/CHF - ยูโร/ฟรังก์สวิส</option>
                    <option value="NZD/CAD">NZD/CAD - ดอลลาร์นิวซีแลนด์/ดอลลาร์แคนาดา</option>
                </optgroup>
            </select>

            <select id="timeframe">
                <option value="1">1 นาที</option>
                <option value="5">5 นาที</option>
                <option value="15">15 นาที</option>
                <option value="30">30 นาที</option>
                <option value="60">1 ชั่วโมง</option>
                <option value="240">4 ชั่วโมง</option>
                <option value="D">1 วัน</option>
            </select>

            <button onclick="fetchData()">วิเคราะห์ข้อมูล</button>
        </div>

        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>

        <div class="indicators">
            <div class="indicator-card">
                <h3>Moving Averages</h3>
                <table id="maTable">
                    <thead>
                        <tr>
                            <th>ระยะเวลา</th>
                            <th>ค่า</th>
                            <th>สัญญาณ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="indicator-card">
                <h3>Technical Indicators</h3>
                <table id="indicatorTable">
                    <thead>
                        <tr>
                            <th>ตัวชี้วัด</th>
                            <th>ค่า</th>
                            <th>สัญญาณ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="loading">กำลังโหลดข้อมูล...</div>

    <script>
        let priceChart = null;

        // ฟังก์ชันสำหรับคำนวณ Technical Indicators
        function calculateMA(prices, period) {
            const ma = [];
            for (let i = period - 1; i < prices.length; i++) {
                const sum = prices.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                ma.push(sum / period);
            }
            return ma;
        }

        function calculateEMA(prices, period) {
            const k = 2 / (period + 1);
            let ema = [prices[0]];
            
            for (let i = 1; i < prices.length; i++) {
                ema.push(prices[i] * k + ema[i - 1] * (1 - k));
            }
            
            return ema;
        }

        function calculateRSI(prices, period = 14) {
            const changes = prices.map((price, index) => 
                index === 0 ? 0 : price - prices[index - 1]
            );

            const gains = changes.map(change => change > 0 ? change : 0);
            const losses = changes.map(change => change < 0 ? -change : 0);

            const avgGain = calculateEMA(gains, period);
            const avgLoss = calculateEMA(losses, period);

            const rsi = avgGain.map((gain, i) => {
                const loss = avgLoss[i];
                if (loss === 0) return 100;
                const rs = gain / loss;
                return 100 - (100 / (1 + rs));
            });

            return rsi;
        }

        function calculateMACD(prices, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const fastEMA = calculateEMA(prices, fastPeriod);
            const slowEMA = calculateEMA(prices, slowPeriod);
            
            const macdLine = fastEMA.map((fast, i) => fast - slowEMA[i]);
            const signalLine = calculateEMA(macdLine, signalPeriod);
            
            return {
                macdLine,
                signalLine,
                histogram: macdLine.map((macd, i) => macd - signalLine[i])
            };
        }

        function calculateBollingerBands(prices, period = 20, multiplier = 2) {
            const ma = calculateMA(prices, period);
            const stdDev = prices.map((price, i) => {
                if (i < period - 1) return null;
                const slice = prices.slice(i - period + 1, i + 1);
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const squaredDiffs = slice.map(x => Math.pow(x - mean, 2));
                return Math.sqrt(squaredDiffs.reduce((a, b) => a + b, 0) / period);
            });

            return {
                middle: ma,
                upper: ma.map((m, i) => m + (multiplier * stdDev[i])),
                lower: ma.map((m, i) => m - (multiplier * stdDev[i]))
            };
        }

        async function fetchData() {
            const loading = document.querySelector('.loading');
            loading.style.display = 'flex';

            try {
                const currencyPair = document.getElementById('currencyPair').value;
                const timeframe = document.getElementById('timeframe').value;
                const data = await getPolygonData(currencyPair, timeframe);
                
                // Process data and update charts
                updateCharts(data);
                updateIndicators(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล');
            } finally {
                loading.style.display = 'none';
            }
        }

        function updateCharts(data) {
            const prices = data.map(item => item.c);
            const timestamps = data.map(item => moment(item.t).format('HH:mm'));

            if (priceChart) {
                priceChart.destroy();
            }

            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Price',
                        data: prices,
                        borderColor: '#2980b9',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: document.getElementById('currencyPair').value
                        }
                    }
                }
            });

           // Add Moving Averages
           const ma20 = calculateMA(prices, 20);
            const ma50 = calculateMA(prices, 50);
            const ma200 = calculateMA(prices, 200);

            priceChart.data.datasets.push({
                label: 'MA20',
                data: [...Array(20).fill(null), ...ma20],
                borderColor: '#27ae60',
                borderWidth: 1,
                fill: false
            });

            priceChart.data.datasets.push({
                label: 'MA50',
                data: [...Array(50).fill(null), ...ma50],
                borderColor: '#e74c3c',
                borderWidth: 1,
                fill: false
            });

            // Add Bollinger Bands
            const bollinger = calculateBollingerBands(prices);
            priceChart.data.datasets.push({
                label: 'Upper BB',
                data: bollinger.upper,
                borderColor: '#8e44ad',
                borderWidth: 1,
                fill: false
            });

            priceChart.data.datasets.push({
                label: 'Lower BB',
                data: bollinger.lower,
                borderColor: '#8e44ad',
                borderWidth: 1,
                fill: '+1'
            });

            priceChart.update();
        }

        function updateIndicators(data) {
            const prices = data.map(item => item.c);
            
            // Calculate indicators
            const rsi = calculateRSI(prices);
            const macd = calculateMACD(prices);
            const bollinger = calculateBollingerBands(prices);
            
            // Update Moving Averages table
            const maTable = document.getElementById('maTable').getElementsByTagName('tbody')[0];
            maTable.innerHTML = '';
            
            const periods = [20, 50, 200];
            periods.forEach(period => {
                const ma = calculateMA(prices, period);
                const currentMA = ma[ma.length - 1];
                const currentPrice = prices[prices.length - 1];
                const signal = currentPrice > currentMA ? 'ขึ้น' : 'ลง';
                const row = maTable.insertRow();
                row.innerHTML = `
                    <td>MA${period}</td>
                    <td>${currentMA.toFixed(4)}</td>
                    <td class="prediction-${signal === 'ขึ้น' ? 'up' : 'down'}">${signal}</td>
                `;
            });

            // Update Technical Indicators table
            const indicatorTable = document.getElementById('indicatorTable').getElementsByTagName('tbody')[0];
            indicatorTable.innerHTML = '';
            
            // RSI
            const currentRSI = rsi[rsi.length - 1];
            const rsiSignal = currentRSI > 70 ? 'ขาย' : currentRSI < 30 ? 'ซื้อ' : 'รอ';
            const rsiRow = indicatorTable.insertRow();
            rsiRow.innerHTML = `
                <td>RSI (14)</td>
                <td>${currentRSI.toFixed(2)}</td>
                <td class="prediction-${rsiSignal === 'ซื้อ' ? 'up' : rsiSignal === 'ขาย' ? 'down' : ''}">${rsiSignal}</td>
            `;

            // MACD
            const currentMACD = macd.macdLine[macd.macdLine.length - 1];
            const currentSignal = macd.signalLine[macd.signalLine.length - 1];
            const macdSignal = currentMACD > currentSignal ? 'ซื้อ' : 'ขาย';
            const macdRow = indicatorTable.insertRow();
            macdRow.innerHTML = `
                <td>MACD</td>
                <td>${currentMACD.toFixed(4)}</td>
                <td class="prediction-${macdSignal === 'ซื้อ' ? 'up' : 'down'}">${macdSignal}</td>
            `;

            // Bollinger Bands
            const currentBB = {
                upper: bollinger.upper[bollinger.upper.length - 1],
                middle: bollinger.middle[bollinger.middle.length - 1],
                lower: bollinger.lower[bollinger.lower.length - 1]
            };
            const currentPrice = prices[prices.length - 1];
            let bbSignal = 'รอ';
            if (currentPrice > currentBB.upper) bbSignal = 'ขาย';
            if (currentPrice < currentBB.lower) bbSignal = 'ซื้อ';
            
            const bbRow = indicatorTable.insertRow();
            bbRow.innerHTML = `
                <td>Bollinger Bands</td>
                <td>${currentBB.middle.toFixed(4)}</td>
                <td class="prediction-${bbSignal === 'ซื้อ' ? 'up' : bbSignal === 'ขาย' ? 'down' : ''}">${bbSignal}</td>
            `;

            // Calculate overall prediction
            const prediction = generatePrediction({
                rsi: currentRSI,
                macd: currentMACD,
                signal: currentSignal,
                price: currentPrice,
                upperBB: currentBB.upper,
                lowerBB: currentBB.lower
            });

            // Add prediction row
            const predictionRow = indicatorTable.insertRow();
            predictionRow.innerHTML = `
                <td><strong>Overall Prediction</strong></td>
                <td>${prediction.confidence.toFixed(1)}%</td>
                <td class="prediction-${prediction.action === 'ซื้อ' ? 'up' : 'down'}">${prediction.action}</td>
            `;
        }

        async function getPolygonData(symbol, timeframe) {
            const apiKey = 'vKgrARjapRFc83uF03sdYhW5bovutb6l'; // Replace with your Polygon API key
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 7);

            const startStr = start.toISOString().split('T')[0];
            const endStr = end.toISOString().split('T')[0];

            try {
                const formattedSymbol = symbol.replace('/', '');
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/C:${formattedSymbol}/range/${timeframe}/minute/${startStr}/${endStr}?apiKey=${apiKey}`
                );
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                if (!data.results || data.results.length === 0) {
                    throw new Error('No data available');
                }
                return data.results;
            } catch (error) {
                console.error('Error fetching from Polygon API:', error);
                // Return sample data for demonstration
                return Array.from({length: 100}, (_, i) => ({
                    t: new Date(Date.now() - (99 - i) * 60000).getTime(),
                    c: Math.random() * 10 + 90
                }));
            }
        }

        function generatePrediction(indicators) {
            let buySignals = 0;
            let sellSignals = 0;
            let totalSignals = 0;

            // RSI signals
            if (indicators.rsi > 70) sellSignals++;
            else if (indicators.rsi < 30) buySignals++;
            totalSignals++;

            // MACD signals
            if (indicators.macd > indicators.signal) buySignals++;
            else sellSignals++;
            totalSignals++;

            // Bollinger Bands signals
            if (indicators.price > indicators.upperBB) sellSignals++;
            else if (indicators.price < indicators.lowerBB) buySignals++;
            totalSignals++;

            const buyProbability = (buySignals / totalSignals) * 100;
            const sellProbability = (sellSignals / totalSignals) * 100;

            return {
                action: buyProbability > sellProbability ? 'ซื้อ' : 'ขาย',
                confidence: Math.max(buyProbability, sellProbability)
            };
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        // Add event listeners
        document.getElementById('currencyPair').addEventListener('change', fetchData);
        document.getElementById('timeframe').addEventListener('change', fetchData);

        // Start real-time updates
        function startRealTimeUpdates() {
            setInterval(fetchData, 60000); // Update every minute
        }

        startRealTimeUpdates();
    </script>
</body>
</html>